#### Anroid-荔枝FM面经

上周，有幸参加荔枝FM的面试，因为疫情原因，都是电话面试，一共有2轮技术面，一轮HR面。

面试过程还算顺利，虽然还不知道结果，希望能进吧，也算是第一次面大厂，本篇就记录一下我面试过程中问的一些问题。我的项目主要是IM和直播，所以问的这方面比较多。

## 一面

1. 自我介绍
	- 略，做过哪些项目，则哪些模块。

2. 了解项目类型、主要负责的模块。
	- 语音直播、IM聊天、话题问答

3. IM聊天使用什么技术做的？
	- 使用WebSocket技术，基于OkHttp和RxJava封装，每一个聊天都是一个连接，当时做了一个优化处理。
	- 使用RxJava的shared操作符，让兼容同一个房间的订阅者监听同一个连接，而不是每次连接都创建一个。
	- 聊天室分为，一对多群聊和一对一单聊，群聊消息比较多时，RxJava发送的模型要转换为UI页面需要的模型时，会比较多的频繁创建和销毁，会有内存抖动，所以我当时使用享元模式了，循环利用RxJava发送的模型，来避免内存问题。
	- 聊天页面使用RecyclerView实现聊天记录列表，支持发送文字、图片、语音，发送语音的手势参考微信，长按录制，松手发送，上滑取消，所以语音发送按钮为自定义控件，处理触摸事件。
	- 聊天室分为，一对多群聊（付费）和一对一单聊（免费），2种聊天室，我使用策略模式切换不同的聊天类型。

4. WebSocket是怎么去进行数据的发送和接收的，网络通讯这一块？
	- WebSocket延续的是HTTP的协议，经过三次握手，创建连接，连接成功后，就可以互相发送消息。发送消息这块会有一个心跳的补充，心跳是为了防止双方长时间不发消息时，导致服务端认为连接断开，而断开了连接。通过心跳机制，当一方长时间没有发送心跳，后端会发送一个对方离线的IM消息，实现双方的在线状态的监听。

5. 刚才说到的三次握手，是基于TCP协议吗？
	- 对，基于TCP\IP协议，长连接。

6. 举一个场景，IM群聊聊天的消息特别多，聊天消息有1M条，你会怎么去优化？
	- 内存处理：享元模型，对象缓存、复用消息模型。
	- 收到消息时，RecyclerView使用notifyItemInsert()等方法，只刷新增加的部分，而不是使用notifyDataSetChange()来刷新整个列表。或者使用DiffUtil，差分数据，减少刷新。
	- 消息分类型，可以分多个类型Type，切换显示不同类型的消息。
	- 如果是直播的IM列表，消息会一直刷，但并不是所有的消息需要保留。所以当，增加1条消息时，尾部也相应减少1条，即使是上万的消息涌入，列表始终也是维持20条消息左右。

7. 上万条IM消息，大量的数据库写入，多线程，怎么保证插入是最高效的？
	- 大量数据写入数据库，开启一个事务，批量插入，而不是一条条的插入。
	- 做一个插入队列，积累到一定数量后，再批量插入数据库。
	- 多线程操作数据库，加锁，使用synchronized或者Lock，来保证数据没有脏数据。

8. 你负责的直播模块，主要有哪些东西呢？
	- 直播基于即构SDK搭建。
	- 直播间中有非常多的状态，例如主播关注状态、点赞状态，而更改这些状态的地方有非常多，例如IM列表有一个关注卡片，顶部的顶部栏上有一个关注状态等，如果每个入口经过用户切换状态后，都去操作每个渠道的状态切换，会导致一个网状调用的耦合，所以当时我采用MVVM架构，使用LiveData处理关注状态、点赞状态，每个入口设置LiveData的数据，并且监听LiveData的数据改变，即可实现关注点分离，解耦每个入口。
	- 直播界面比较复杂，我使用组合模式，将界面的每一个部分都拆分成组件，组件监听需要关注的状态，例如主播关注状态，IM列表组件和顶部栏都订阅关注状态，收到状态改变监听回调时，切换组件的UI，例如未关注文字改为已关注。
	- 组件支持内嵌组件（子组件），可以处理多角色多UI样式差别的问题，角色有主播、上麦用户、普通用户等，我将不同的角色对应一个子组件，当收到角色切换的IM消息时，切换子组件即可实现不同的UI切换。
	- 因为拆分了组件后，例如返回键onBackPressed()、onActivityResult()这些事件需要分发到每个组件，例如按下返回键时，悬浮的公告栏需要隐藏，弹起的工具箱需要收回。所以我使用责任链模式，其实每个组件串起来就是一个树形的结构，事件先从最顶层的组件开始分发，每个组件收到事件后，先找自己的子组件进行分发，询问当前遍历到的子组件是否要处理，需要处理返回true，不处理则返回false，一层层的往上抛，找到最后的处理者，进行事件处理，例如直播的打赏，支付完毕后回调onActivityResult()，这个事件就会分发到组件中，例如Pay组件需要处理，则复写组件的onActivityResult()，经过责任链模式的方式，一层层找到组件，组件再进行事件的消费和处理。
	- 使用了组件模式后，Activity、Fragment代码量很少，只有400行，都是组件的创建和事件的分发，职责都拆分到对应的组件里面。
	- 当时直播间的组件拆分大概有20个左右，组件越来越多，也遇到一些问题，就是进入直播间后会卡顿和慢，所以当时也做了优化，让一些动画组件和弹幕组件在特定操作时，再延迟加载，让IM、直播推流等这些必须组件，先优先加载初始化，提高进入直播间的速度。直播间自定义组件比较多，当自定义控件和父布局是同类型时，使用merge标签代替，一些重量级的View，又是特定操作才显示的，使用ViewStub标签进行懒加载。

9. 除了刚才直播的卡顿优化，平时还会做一些哪些方面的优化？
	- 一些第三方SDK不在Application初始化，推迟到主页面进行初始化。
	- 一些资源数据可以异步加载，则可以使用异步线程进行加载。
	- 使用AsyncLayoutInflater，异步线程中加载View，再在主线程中填充View。

10. 子线程可以创建View吗？
	- 可以，AsyncLayoutInflater就是使用子线程创建View后，再使用Handler发送创建的View实例发送到主线程进行回调。如果使用子线程创建View，更新View时也需要在子线程中更新。

11. 直播推流和IM用什么做的？
	- 直播推流使用即构，IM使用腾讯的TIM。

12. 直播有打赏吗？是怎么做的？礼物的特效怎么做？
	- 有的，有打赏和送礼物，打赏和送礼物是支付完毕后，发送一个IM消息到聊天，收到消息后显示相应的UI处理。
	- 特效是有的，例如上麦需要填写资料，老师查看资料时，会发送一个IM消息，收到消息后，显示一个魔法阵的效果，这种比较静态、复杂的效果会使用Lottie、SVGAPlayer，如果是一些动态的效果，则使用自定义View和动画，例如打赏有一个金额图片拼接，不同的金额，则拼接的不一样。

13. 特效的资源是放在哪里？
	- 当时例如不是特别多，所以就放在项目中，如果例如比较多，效果文件也比较大，则可以使用插件化或者接口动态下发资源包，下载完成后解压，再来使用。

14. LiveData、EventBus和Broadcast之间有什么区别？
	- LiveData使用了Google的Lifecycle组件，可以自动绑定、解绑生命周期，而不像EventBus、Broadcast需要手动注册和解绑，如果忘记了就会内存泄露。LiveData有一个Active活跃特性，当Activity被另外一个Activity覆盖时，变为不活跃，这时数据更新，LiveData则不会收到更新，而是到了Activity再次显示时，再进行更新。
	- LiveData还有一个特性是可以和ViewModel配合使用，当我们App后台了，因为内存不足被系统杀死，我们回到页面时重建页面，ViewModel中的LiveData的数据会保存，而不需要我们在onSaveInstanceState()中保存数据和onRestoreInstanceState()中恢复数据。
	- Broadcast是跨进程，一般我们使用Broadcast是跟别的App或者和系统组件进行通信，可以跨进程使用，相比EventBus重量级，当我们不需要跨进程通信，则可以使用LocalBroadcast来进行App内部的通信，并且没有Broadcast的权限问题。
	- EventBus和LocalBroadcast类型，也是在App间使用，EventBus的好处是使用一个模型类进行消息标记和回调，就不需要像Broadcast广播需要使用Intent和很多的key来标识数据。EventBus还可以指定线程，只要在回调事件中使用@Subscribe注解，使用threadMode属性标识回调的线程，就可以在指定的线程中回调，而不需要像Broadcast需要收到后再手动开一个线程进行处理。

13. EventBus是怎么实现线程切换的？
	- EventBus内部有一个线程池，先注册后，通过post()方法发送事件，EventBus会根据注解上的threadMode属性确定需要放到哪个线程进行回调，每个threadMode属性值都是一种Poster，其实是使用了策略模式，每个Poster策略都有对应的线程池，将回调交给相应的Poster进行回调即可做到不同的线程中回调。

14. 你还有什么问题想问我？
	- 荔枝目前有哪些项目在做？直播项目Android端多少个人一起做？

15. 您对现在的职业规划是怎样的呢？觉得自己还欠缺哪一块？
	- 略。

16. 平时您是怎么学习？提交自己的？
	- 工作中问题，总结和输出到博客，在小组内分享。
	- 看别人的博客，自己也总结转化为自己的知识。
	- 思考项目中的问题和需求，思考怎么可以优雅、快捷的应对需求，平时会看设计模式的书，并在项目中实施。

17. 项目中遇到的问题和难点，你怎么解决?
	- 例如项目的第三次迭代，增加了最小化的功能，而之前直播的状态我是放在LiveData中，如果直播页面关闭了，LiveData则会自动解绑，导致数据丢失。一开始改得比较急，先将Activity改为Fragment，最小化时隐藏Fragment来达到最小化，但是直播UI的一些占用内存还是在继续，为了内存考虑，后续还是改回了Activity，再将状态数据使用RxJava订阅的方式，让组件订阅数据。

一面结束，二面会在3个工作日内通知。

## 二面

一面结束当天的晚上，HR电话通知我明天的二面。

## 总结