## åŠ¨æ‰‹åšè§†é¢‘åŠ¨æ€å£çº¸~

#### æŸå¤©ï¼Œå¥³æœ‹å‹åœ¨åˆ·æŸéŸ³ï¼Œçªç„¶çœ‹åˆ°æœ‰è§†é¢‘ä½œä¸ºé”å±ï¼Œååˆ†å´‡æ‹œï¼Œæ’’å¨‡çš„çœ¼ç”Ÿçœ‹ç€æˆ‘...çœ‹æ¥è¿™ä¸ªéœ€æ±‚èº²ä¸è¿‡äº†ï¼Œèº«ä¸ºå®‰å“ä»”ï¼Œè¿™æœ‰ä»€ä¹ˆçš„ï¼Œå¼€å¹²ï¼

#### æœäº†ä¸‹èµ„æ–™ï¼Œå®ç°å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š
- æ­¥éª¤ä¸€ï¼šæ–°å»ºç±»ï¼Œç»§æ‰¿WallpaperServiceï¼Œå®ç°æŠ½è±¡æ–¹æ³•ã€‚
- æ­¥éª¤äºŒï¼šres->xmlæ–‡ä»¶å¤¹ï¼Œæ–°å»ºxmlæ–‡ä»¶ï¼ŒwallpaperèŠ‚ç‚¹ï¼Œæè¿°åŠ¨æ€å£çº¸ï¼Œå°±æ˜¯ä¸€ä¸ªç›¸å½“äºé…ç½®æ–‡ä»¶ã€‚
- æ­¥éª¤ä¸‰ï¼šAndroidManifest.xmlæ¸…å•æ–‡ä»¶ï¼Œé…ç½®serviceå’Œç»‘å®šæ­¥éª¤äºŒçš„xmlæ–‡ä»¶ã€‚

#### æ€è·¯

- ä½¿ç”¨è§†é¢‘åŠ¨æ€å£çº¸çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼ŒWallpaperServiceéœ€è¦è¿”å›ä¸€ä¸ªEngineç±»å¯¹è±¡ï¼ŒEngineç±»ä¼šå›è°ƒè¿”å›æ¡Œé¢çš„SurfaceHolderï¼Œæˆ‘ä»¬åˆ™å¯ä»¥ç”¨MediaPlayeræ¥ç»‘å®šè¿™ä¸ªSurfaceHolderæ¥æ’­æ”¾è§†é¢‘ã€‚è¿™æ ·æˆ‘ä»¬çš„æ¡Œé¢å’Œå£çº¸å°±å¯ä»¥æ’­æ”¾è§†é¢‘å•¦~

#### ä¸‹é¢æ˜¯ç ä»£ç æ—¶é—´~

- ç¬¬ä¸€æ­¥ï¼šæ–°å»ºç±»ï¼Œç»§æ‰¿WallpaperServiceï¼Œå®ç°æŠ½è±¡æ–¹æ³•ã€‚å…·ä½“çœ‹æ³¨é‡Šå§~
è¿™é‡Œåªç»™å‡ºå¤å†™æ–¹æ³•å…ˆï¼Œåé¢å†ä»”ç»†å†™~

```
public class VideoLiveWallpaper extends WallpaperService {
	//è¿”å›ä¸€ä¸ªEngineå¯¹è±¡ï¼Œè¿™é‡Œ
	@Override
    public Engine onCreateEngine() {
        return new VideoEngine();
    }
    
    class VideoEngine extends Engine {
    	@Override
        public void onCreate(SurfaceHolder surfaceHolder) {
        		//Engineå¯¹è±¡è¢«åˆ›å»ºæ—¶å›è°ƒï¼Œè¿™é‡Œå¯ä»¥åšå¹¿æ’­æ³¨å†Œç­‰æ“ä½œ
        }
        
        @Override
        public void onDestroy() {
			  //Engineå¯¹è±¡è¢«é”€æ¯æ—¶å›è°ƒï¼Œè¿™é‡Œå¯ä»¥æ³¨é”€å¹¿æ’­æ³¨å†Œç­‰æ“ä½œ
            super.onDestroy();
        }
        
        @Override
        public void onVisibilityChanged(boolean visible) {
        	  //æ˜¾ç¤ºã€éšè—æ—¶åˆ‡æ¢ï¼Œåœ¨æ¡Œé¢æ—¶ä¸ºæ˜¾ç¤ºï¼Œè·³è½¬åˆ°åˆ«çš„Appé¡µé¢æ—¶ä¸ºéšè—
        	  //è¿™é‡Œåšè§†é¢‘çš„æš‚åœå’Œæ¢å¤æ’­æ”¾~
        }
        
        @Override
        public void onSurfaceCreated(SurfaceHolder holder) {
        	 //SurfaceViewè¢«åˆ›å»ºæ—¶å›è°ƒï¼Œæˆ‘ä»¬çš„è§†é¢‘MediaPlayerå¯¹è±¡æ’­æ”¾çš„è§†é¢‘è¾“å‡ºåœ¨è¿™ä¸ªsurfaceä¸Šã€‚
        }
        
        @Override
        public void onSurfaceDestroyed(SurfaceHolder holder) {
        	//Surfaceé”€æ¯æ—¶å›è°ƒï¼Œè¿™é‡Œæˆ‘ä»¬åº”è¯¥é”€æ¯MediaPlayerï¼Œå›æ”¶MediaPlayerã€‚
        }
    }
}
```
- ç¬¬äºŒæ­¥ï¼Œres->xmlæ–‡ä»¶å¤¹ï¼Œæ–°å»ºxmlæ–‡ä»¶ï¼ŒwallpaperèŠ‚ç‚¹ï¼Œæè¿°åŠ¨æ€å£çº¸ï¼Œå°±æ˜¯ä¸€ä¸ªç›¸å½“äºé…ç½®æ–‡ä»¶ã€‚thumbnailæ ‡è¯†åœ¨åŠ¨æ€å£çº¸è®¾ç½®é¡µé¢ä¸Šæ˜¾ç¤ºçš„å›¾æ ‡ã€‚

```
<?xml version="1.0" encoding="utf-8"?>
<wallpaper xmlns:android="http://schemas.android.com/apk/res/android"
           android:thumbnail="@mipmap/fa_live_wallpaper_icon"/>
```

- ç¬¬ä¸‰æ­¥ï¼ŒAndroidManifest.xmlæ¸…å•æ–‡ä»¶ï¼Œé…ç½®serviceå’Œç»‘å®šæ­¥éª¤äºŒçš„xmlæ–‡ä»¶ã€‚meta-dataèŠ‚ç‚¹é…ç½®æˆ‘ä»¬ç¬¬äºŒæ­¥å†™çš„xmlæ–‡ä»¶ã€‚

```
<!-- é…ç½®å®æ—¶å£çº¸Service -->
        <service
                android:name="me.wally.arch.livewallpaper.VideoLiveWallpaper"
                android:label="@string/fs_video_live_wallpaper"
                android:permission="android.permission.BIND_WALLPAPER"
                android:process=":wallpaper">
            <!-- ä¸ºå®æ—¶å£çº¸é…ç½®intent-filter -->
            <intent-filter>
                <action android:name="android.service.wallpaper.WallpaperService" />
            </intent-filter>
            <!-- ä¸ºå®æ—¶å£çº¸é…ç½®meta-data -->
            <meta-data
                    android:name="android.service.wallpaper"
                    android:resource="@xml/fs_video_wallpaper" />
        </service>
```

#### ä¸Šé¢åˆ†åˆ«åˆ†æäº†WallpaperServiceæœåŠ¡çš„å‡ ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥å°†MediaPlayerçš„è§†é¢‘è¾“å‡ºåˆ°æ¡Œé¢çš„SufaceViewä¸­~

- æ–°å»ºEngineç±»å­ç±»ï¼ŒVideoEngineï¼Œä½œä¸ºæˆ‘ä»¬çš„Engineç±»ã€‚åœ¨Serviceçš„onCreateEngine()æ–¹æ³•ä¸­è¿”å›å‡ºå»ã€‚

```
@Override
    public Engine onCreateEngine() {
        return new VideoEngine();
    }
```

- å¤å†™onSurfaceCreated()æ–¹æ³•ï¼Œåœ¨Sufaceåˆ›å»ºæ—¶ï¼Œåˆ›å»ºMediaPlayer

```
@Override
        public void onSurfaceCreated(SurfaceHolder holder) {
            super.onSurfaceCreated(holder);
            mMediaPlayer = new MediaPlayer();
            mMediaPlayer.setSurface(holder.getSurface());
            try {
                mMediaPlayer.setDataSource(getApplicationContext(), Uri.parse(videoFilePath));
                mMediaPlayer.setLooping(true);
                mMediaPlayer.setVolume(0, 0);
                mMediaPlayer.prepare();
                mMediaPlayer.start();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
```

- åœ¨onSurfaceDestroyed()æ–¹æ³•ä¸­é‡Šæ”¾MediaPlayerã€‚

```
@Override
        public void onSurfaceDestroyed(SurfaceHolder holder) {
            super.onSurfaceDestroyed(holder);
            mMediaPlayer.release();
            mMediaPlayer = null;
        }
```

- åœ¨onVisibilityChanged()æ–¹æ³•ä¸­ï¼Œæ¡Œé¢æ˜¾ç¤ºæ—¶æ’­æ”¾è§†é¢‘ï¼Œä¸å¯è§æ—¶æš‚åœæ’­æ”¾ã€‚

```
@Override
        public void onVisibilityChanged(boolean visible) {
            if (visible) {
                mMediaPlayer.start();
            } else {
                mMediaPlayer.pause();
            }
        }
```

#### åˆ°è¿™é‡Œå…¶å®æˆ‘ä»¬å·²ç»å°†è§†é¢‘åŠŸèƒ½åšå®Œå•¦~æ˜¯ä¸æ˜¯æŒºç®€å•çš„~

1. ä½†æ˜¯ï¼Œï¼Œï¼Œæˆ‘ä»¬è¦çš„æ•ˆæœæ˜¯æ¡Œé¢å’Œé”å±éƒ½æ˜¯è§†é¢‘ï¼ŒåŸç”ŸROMæµ‹è¯•æ˜¯å¯ä»¥æ»´ï¼Œå›½äº§ROMéƒ½æ”¹ä¸ºä»–ä»¬è‡ªå®¶çš„ä¸»é¢˜è®¾ç½®äº†ğŸ˜‚ï¼ˆæˆ‘å†‡çœ¼ç‡ï¼ï¼‰
2. æ¥ä¸‹æ¥å°±æ˜¯å†™Activityï¼Œç‚¹æŒ‰é’®è®¾ç½®æˆ‘ä»¬çš„åŠ¨æ€å£çº¸~

- æ–°å»ºActivityï¼Œè¿™ä¸€å †æ“ä½œå°±ä¸å†™äº†ï¼Œåªè´´é‡ç‚¹ã€‚

- æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œç‚¹å‡»æŒ‰é’®ï¼Œè°ƒç”¨ç³»ç»Ÿå›¾åº“é€‰æ‹©è§†é¢‘ï¼Œæ‹¿åˆ°è§†é¢‘åœ°å€åï¼Œè°ƒç”¨ç³»ç»Ÿè®¾ç½®åŠ¨æ€å£çº¸çš„Apiï¼Œå°†è§†é¢‘åœ°å€ä¼ è¿‡å»ï¼Œå†å¹¿æ’­é€šçŸ¥æˆ‘ä»¬çš„Serviceçš„MediaPlayeråˆ‡æ¢è§†é¢‘~

1. é¦–å…ˆæ˜¯æˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿå›¾åº“é€‰æ‹©æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘åšäº†æŠ½å–ï¼Œå°†é€‰æ‹©å·¥ä½œäº¤ç»™äº†ä¸€ä¸ªå«FileChooseCompatçš„ç±»ï¼Œå°†é€‰æ‹©èµ„æºçš„å·¥ä½œäº¤ç»™å®ƒã€‚ç„¶åå†™äº†ä¸€ä¸ªChooseFileCallbackå›è°ƒæ¥å£ï¼Œå›è°ƒé€‰æ‹©ç»“æœåˆ°Activityã€‚

```
public class FileChooseCompat {
    /**
     * èµ„æºç±»å‹åˆ†éš”ç¬¦
     */
    private static final String RESOURCES_TYPE_SEPARATOR = ";";

    private FragmentActivity mActivity;

    /**
     * èµ„æºç±»å‹
     */
    public enum ResourceType {
        /**
         * æ— ç±»å‹é™åˆ¶
         */
        GENERAL("0", "*/*", "æ— ç±»å‹é™åˆ¶"),
        /**
         * é€‰æ‹©å›¾ç‰‡
         */
        IMAGE("1", "image/*", "é€‰æ‹©å›¾ç‰‡"),
        /**
         * é€‰æ‹©éŸ³é¢‘
         */
        AUDIO("2", "audio/*", "é€‰æ‹©éŸ³é¢‘"),
        /**
         * é€‰æ‹©è§†é¢‘ï¼Œï¼ˆmp4 3gp æ˜¯androidæ”¯æŒçš„è§†é¢‘æ ¼å¼ï¼‰
         */
        VIDEO("3", "video/*", "é€‰æ‹©è§†é¢‘");

        private String mType;
        private String mIntentType;
        private String mDesc;

        ResourceType(String type, String intentType, String desc) {
            mType = type;
            mIntentType = intentType;
            mDesc = desc;
        }

        public String getType() {
            return mType;
        }

        public String getIntentType() {
            return mIntentType;
        }

        public String getDesc() {
            return mDesc;
        }

        @Override
        public String toString() {
            return this.mType;
        }
    }

    public interface ChooseFileCallback {
        void onChoose(Uri uri, String filePath);

        void onChooseCancel();
    }

    public static class SimpleChooseFileCallback implements ChooseFileCallback {

        @Override
        public void onChoose(Uri uri, String filePath) {
        }

        @Override
        public void onChooseCancel() {
        }
    }

    private FileChooseCompat() {
    }

    private FileChooseCompat(FragmentActivity activity) {
        this.mActivity = activity;
    }

    public static FileChooseCompat create(FragmentActivity activity) {
        return new FileChooseCompat(activity);
    }

    /**
     * é€‰æ‹©å›¾ç‰‡
     */
    public void startChooseImageFile(ChooseFileCallback chooseFileCallback) {
        startChooseFile(chooseFileCallback, ResourceType.IMAGE);
    }

    /**
     * é€‰æ‹©éŸ³é¢‘
     */
    public void startChooseAudioFile(ChooseFileCallback chooseFileCallback) {
        startChooseFile(chooseFileCallback, ResourceType.AUDIO);
    }

    /**
     * é€‰æ‹©è§†é¢‘
     */
    public void startChooseVideoFile(ChooseFileCallback chooseFileCallback) {
        startChooseFile(chooseFileCallback, ResourceType.VIDEO);
    }

    /**
     * é€‰æ‹©å›¾ç‰‡å’Œè§†é¢‘
     */
    public void startChooseImageAndVideo(ChooseFileCallback chooseFileCallback) {
        startChooseFile(chooseFileCallback, ResourceType.IMAGE, ResourceType.VIDEO);
    }

    private void startChooseFile(ChooseFileCallback chooseFileCallback, final ResourceType... type) {
        FileChooseDelegateFragment delegateFragment = DelegateFragmentFinder
                .getInstance()
                .find(mActivity, FileChooseDelegateFragment.class);
        //æ‹¼æ¥å¤šä¸ªèµ„æºç±»å‹
        StringBuilder builder = new StringBuilder();
        for (FileChooseCompat.ResourceType resourcesType : type) {
            builder.append(resourcesType.getIntentType());
            builder.append(RESOURCES_TYPE_SEPARATOR);
        }
        String typeResult = builder.toString();
        typeResult = typeResult.substring(0, typeResult.length() - 1);
        delegateFragment.startChooseFile(chooseFileCallback, typeResult);
    }
}
```

2. è°ƒç”¨ç³»ç»Ÿå›¾åº“Apiï¼Œéœ€è¦å¤å†™onActivityResult()æ‹¿åˆ°é€‰æ‹©æ–‡ä»¶çš„åœ°å€ï¼Œæˆ‘è¿™é‡Œå°†onActivityResult()çš„å›è°ƒç»™ä»£ç†Fragmentã€‚

```
public class FileChooseDelegateFragment extends BaseDelegateFragment {
    private static final int REQUEST_CHOOSE_FILE = 100;
    /**
     * é€‰æ‹©å›è°ƒ
     */
    private FileChooseCompat.ChooseFileCallback mChooseFileCallback;
    private UriToPathFactory mUriToPathFactory = new UriToPathFactory();

    /**
     * é€‰æ‹©æ–‡ä»¶
     *
     * @param chooseFileCallback é€‰æ‹©çš„å›è°ƒ
     * @param type               èµ„æºç±»å‹
     */
    public void startChooseFile(FileChooseCompat.ChooseFileCallback chooseFileCallback, final String type) {
        this.mChooseFileCallback = chooseFileCallback;
        runTaskOnStart(new LifecycleTask() {
            @Override
            public void execute(BaseDelegateFragment delegateFragment) {

                //é€‰æ‹©æ–‡ä»¶ï¼Œè°ƒç”¨ç³»ç»Ÿçš„æ–‡ä»¶ç®¡ç†
                Intent intent = new Intent(Intent.ACTION_GET_CONTENT);
                intent.setType(type);
                intent.addCategory(Intent.CATEGORY_OPENABLE);
                startActivityForResult(intent, REQUEST_CHOOSE_FILE);
            }
        });
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {//é€‰æ‹©æ–‡ä»¶è¿”å›
        super.onActivityResult(requestCode, resultCode, data);
        if (resultCode == Activity.RESULT_CANCELED) {
            switch (requestCode) {
                case REQUEST_CHOOSE_FILE:
                    if (mChooseFileCallback != null) {
                        mChooseFileCallback.onChooseCancel();
                    }
                    break;
                default:
                    break;
            }
        } else if (resultCode == Activity.RESULT_OK) {
            switch (requestCode) {
                case REQUEST_CHOOSE_FILE:
                    Uri uri = data.getData();
                    String chooseFilePath = mUriToPathFactory.startUriToPath(getContext(), uri);
                    if (mChooseFileCallback != null) {
                        mChooseFileCallback.onChoose(uri, chooseFilePath);
                    }
                    break;
                default:
                    break;
            }
        }
    }
}
```

3. ActivityæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¼€å§‹è°ƒç”¨~

```
Button chooseVideoBtn = findViewById(R.id.choose_video_btn);
        chooseVideoBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                FileChooseCompat.create(ChooseVideoWallpaperActivity.this).startChooseVideoFile(new FileChooseCompat.SimpleChooseFileCallback() {
                    @Override
                    public void onChoose(Uri uri, String filePath) {
                        //è¿™é‡Œå°†æ–‡ä»¶çš„filePathäº¤ç»™Serviceå¤„ç†ã€‚
                        VideoLiveWallpaper.setWallPaper(ChooseVideoWallpaperActivity.this, filePath);
                    }
                });
            }
        });
```

4. ä¸Šé¢çš„VideoLiveWallpaper.setWallPaper()ï¼Œå°†è§†é¢‘åœ°å€äº¤ç»™Serviceå¤„ç†ã€‚
è¿™é‡Œæœ‰ä¸ªå°é—®é¢˜ï¼Œä¼°è®¡è°·æ­Œåœ¨è®¾è®¡è¿™ä¸ªåŠ¨æ€å£çº¸æ—¶ï¼Œæ²¡æœ‰æä¾›æ˜¯å¦è®¾ç½®æˆåŠŸçš„å›è°ƒï¼Œå°±æ˜¯è¯´è·³è½¬åˆ°ç³»ç»Ÿçš„è®¾ç½®ç•Œé¢åï¼Œæˆ‘ä»¬å°±æ²¡æ³•å¾—çŸ¥ç”¨æˆ·æ˜¯è®¾ç½®äº†æˆ‘ä»¬çš„å£çº¸ï¼Œè¿˜æ˜¯ç‚¹äº†è¿”å›é”®è¿”å›...æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘çš„å¤„ç†æ˜¯ï¼Œè®¾ç½®å‰å°†æ–‡ä»¶åœ°å€ä¿å­˜åˆ°spï¼Œå†è·³è½¬åˆ°ç³»ç»Ÿçš„è®¾ç½®ç•Œé¢ï¼Œå†å¹¿æ’­æ›´æ–°è§†é¢‘åœ°å€ã€‚ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œå°±è¦æ›´æ–°è§†é¢‘åœ°å€ï¼Ÿå› ä¸ºç³»ç»Ÿçš„è®¾ç½®é¡µé¢ï¼Œåœ¨é€‰æ‹©ä½ çš„åŠ¨æ€åœ°å€åï¼Œä¼šè·³è½¬åˆ°ä¸€ä¸ªé¢„è§ˆç•Œé¢ï¼Œæ’­æ”¾ä½ çš„åŠ¨æ€å£çº¸ï¼Œè€Œä¸Šé¢çš„åŠ¨æ€å£çº¸ä¹Ÿæ˜¯ä½¿ç”¨æˆ‘ä»¬å‰é¢è¿”å›Engineç±»ï¼Œå¹¶ä¸”æ¯æ¬¡è¿›å…¥è¯¥ç•Œé¢ï¼ŒEngineç±»ä¸ä¸€å®šä¼šé‡å»ºï¼Œæœ‰æ—¶å€™ä¼šä½¿ç”¨ä¹‹å‰çš„å®ä¾‹ï¼Œè€Œä¸”Engineç±»åˆ›å»ºæ—¶ï¼Œä¹Ÿæ²¡æœ‰æä¾›ä¸€ä¸ªIntentè®¾ç½®ä¸€ä¸ªBundleå‚æ•°å¸¦è¿™ä¸ªåœ°å€è¿‡å»ğŸ˜‚å®Œå…¨ä¸å—è‡ªå·±æ§åˆ¶...æ‰€ä»¥è¿™é‡Œå°±éœ€è¦è¿›è¡Œå¹¿æ’­æ›´æ–°äº†(ğŸ˜‚æ€»æ„Ÿè§‰è¿™å—æ²¡è®¾è®¡å¥½...)ã€‚

- ç”±äºè¦ä½¿ç”¨åˆ°å¹¿æ’­ï¼Œå¹¿æ’­çš„Actionï¼ŒBundleçš„Keyè‡ªç„¶è¦å†™ä¸€ä¸‹~å‘é€å¹¿æ’­çš„æ–¹æ³•å†å°è£…ä¸€ä¸‹åˆ°å†…éƒ¨ã€‚

```

public static final String VIDEO_PARAMS_CONTROL_ACTION = "me.wally.arch.livewallpaper.VideoLiveWallpaper";

    public static final String KEY_ACTION = "action";
    public static final int ACTION_UPDATE_VIDEO_FILE_PATH = 112;

/**
     * è·³è½¬åˆ°åŠ¨æ€å£çº¸è®¾ç½®é¡µé¢
     */
    public static void setWallPaper(Context context, String videoFilePath) {
        //å› ä¸ºæ²¡æœ‰æä¾›æ˜¯å¦è®¾ç½®æˆåŠŸçš„å›è°ƒï¼Œåªèƒ½å½“é€‰æ‹©äº†å°±æ˜¯è®¾ç½®æˆåŠŸ
        saveVideoPath(videoFilePath);
        startNewWallpaper(context);
        updateWallpaperVideo(context);
    }
    
    private static void saveVideoPath(String videoFilePath) {
        //å°†è§†é¢‘åœ°å€ä¿å­˜ï¼Œåé¢å¹¿æ’­æ›´æ–°æ—¶å†è¯»å–
        PropertyHelper.setProperty(KEY_WALLPAPER_VIDEO_DATA_SOURCE_FILE_PATH, videoFilePath);
    }
    
    /**
     * è·³è½¬åˆ°ç³»ç»Ÿçš„åŠ¨æ€å£çº¸è®¾ç½®ç•Œé¢
     */
    private static void startNewWallpaper(Context context) {
        Intent intent = new Intent(WallpaperManager.ACTION_CHANGE_LIVE_WALLPAPER);
        intent.putExtra(WallpaperManager.EXTRA_LIVE_WALLPAPER_COMPONENT, new ComponentName(context, VideoLiveWallpaper.class));
        context.startActivity(intent);
    }
    
    private static void updateWallpaperVideo(Context context) {
        //å‘é€å¹¿æ’­æ›´æ–°
        Intent intent = new Intent(VideoLiveWallpaper.VIDEO_PARAMS_CONTROL_ACTION);
        intent.putExtra(VideoLiveWallpaper.KEY_ACTION, VideoLiveWallpaper.ACTION_UPDATE_VIDEO_FILE_PATH);
        context.sendBroadcast(intent);
    }
```

5. åœ¨VideoEngineçš„onCreate()æ–¹æ³•ä¸­ï¼Œæ³¨å†Œå¹¿æ’­ï¼Œåœ¨onDestroy()æ–¹æ³•ä¸­ï¼Œæ³¨é”€å¹¿æ’­ã€‚è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†é€‰æ‹©è§†é¢‘->è§†é¢‘æ’­æ”¾~

```
@Override
        public void onCreate(SurfaceHolder surfaceHolder) {
            super.onCreate(surfaceHolder);
            IntentFilter intentFilter = new IntentFilter(VIDEO_PARAMS_CONTROL_ACTION);
            registerReceiver(mVideoParamsControlReceiver = new BroadcastReceiver() {
                @Override
                public void onReceive(Context context, Intent intent) {
                    int action = intent.getIntExtra(KEY_ACTION, -1);
                    switch (action) {
                        case ACTION_UPDATE_VIDEO_FILE_PATH:
                            //æ›´æ–°è§†é¢‘æ’­æ”¾æº
                            String videoFilePath = getVideoPath();
                            try {
                                mMediaPlayer.setDataSource(getApplicationContext(), Uri.parse(videoFilePath));
                            } catch (IOException e) {
                                e.printStackTrace();
                            }
                            break;
                        default:
                            break;
                    }
                }
            }, intentFilter);
        }

        @Override
        public void onDestroy() {
            unregisterReceiver(mVideoParamsControlReceiver);
            super.onDestroy();
        }
```

#### ä½ ä»¥ä¸ºè¿™æ ·å°±å®Œäº†å—ï¼Ÿä¸ï¼Œè¿˜æœ‰ç‚¹å°ç¼ºé™·ï¼Œå†™å®Œä»¥ä¸Šä»£ç ï¼Œä½ ä¼šå‘ç°ï¼Œé€‰æ‹©è§†é¢‘åï¼Œå’‹ä¹ˆè§†é¢‘çš„å£°éŸ³éƒ½å‡ºæ¥äº†...å›ä¸ªæ¡Œé¢è¿˜æœ‰å£°éŸ³ï¼Œå“äººå‘¢ğŸ˜‚ã€‚å…¶å®è¿™æ˜¯æ­£å¸¸æ»´ï¼Œè§†é¢‘æ’­æ”¾å°±è‚¯å®šä¼šæ’­å£°éŸ³å•¦ï¼Œé‚£æˆ‘ä»¬æˆ‘è¿˜éœ€è¦åšä¸€æ­¥é™éŸ³æ“ä½œ~

- è®¾ç½®é™éŸ³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œç»™æˆ‘ä»¬MediaPlayerè°ƒç”¨setVolume()æ–¹æ³•ï¼Œæœ‰2ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å·¦å£°é“ï¼Œä¸€ä¸ªæ˜¯å³å£°é“ï¼Œè¦é™éŸ³åˆ™éƒ½è®¾ç½®0ï¼Œä¸é™éŸ³åˆ™1.0fã€‚

```
//è®¾ç½®ä¸é™éŸ³
mMediaPlayer.setVolume(1.0f, 1.0f);
//è®¾ç½®é™éŸ³
mMediaPlayer.setVolume(0, 0);
```
- è®¾ç½®åŒæ ·ä½¿ç”¨å¹¿æ’­é€šçŸ¥ã€‚æä¾›setVolume()æ–¹æ³•ç»™å¤–éƒ¨ä½¿ç”¨ï¼Œæ¯•ç«Ÿä¸èƒ½ä¸€æ£’å­æ‰“æ­»å˜›ï¼Œè¦æ˜¯éœ€æ±‚æ”¹ä¸ºä¸é™éŸ³å‘¢ï¼Ÿè®°å¾—äº§å“çš„è¯ï¼Œåƒä¸‡ä¸è¦ä¿¡ï¼Œè®°ä½ï¼ä»£ç ä¸è¦å†™æ­»~å™¢ï¼Œè¿™æ¬¡éœ€æ±‚æ–¹æ˜¯å¥³æœ‹å‹ğŸ‘©ã€‚

```
	public static final int ACTION_VOICE_SILENCE = 110;
    public static final int ACTION_VOICE_NORMAL = 111;

    /**
     * è®¾ç½®æ˜¯å¦é™éŸ³
     *
     * @param isSilence æ˜¯å¦é™éŸ³
     */
    public static void setVolume(Context context, boolean isSilence) {
        Intent intent = new Intent(VideoLiveWallpaper.VIDEO_PARAMS_CONTROL_ACTION);
        if (isSilence) {
            intent.putExtra(VideoLiveWallpaper.KEY_ACTION, VideoLiveWallpaper.ACTION_VOICE_SILENCE);
        } else {
            intent.putExtra(VideoLiveWallpaper.KEY_ACTION, VideoLiveWallpaper.ACTION_VOICE_NORMAL);
        }
        context.sendBroadcast(intent);
    }
```

- ä¿®æ”¹VideoEngineç±»çš„onCreate()æ–¹æ³•ï¼Œå¹¿æ’­æ¥æ”¶åŠ ä¸Šè®¾ç½®é™éŸ³ã€éé™éŸ³çš„æ“ä½œã€‚

```
@Override
        public void onCreate(SurfaceHolder surfaceHolder) {
            super.onCreate(surfaceHolder);
            IntentFilter intentFilter = new IntentFilter(VIDEO_PARAMS_CONTROL_ACTION);
            registerReceiver(mVideoParamsControlReceiver = new BroadcastReceiver() {
                @Override
                public void onReceive(Context context, Intent intent) {
                    int action = intent.getIntExtra(KEY_ACTION, -1);
                    switch (action) {
                        case ACTION_VOICE_NORMAL:
                            mMediaPlayer.setVolume(1.0f, 1.0f);
                            break;
                        case ACTION_VOICE_SILENCE:
                            mMediaPlayer.setVolume(0, 0);
                            break;
                        case ACTION_UPDATE_VIDEO_FILE_PATH:
                            ...
                            break;
                        default:
                            break;
                    }
                }
            }, intentFilter);
        }
```

- æœ€åActivityï¼Œè®¾ç½®ä¸€ä¸ªåˆ‡æ¢é™éŸ³ã€éé™éŸ³CheckBoxã€‚

```
CheckBox voiceCheckBox = findViewById(R.id.voice_check_box);
        boolean isVolume = getVideoLiveWallpaperSilence();
        voiceCheckBox.setChecked(isVolume);
        voiceCheckBox.setOnCheckedChangeListener(
                new CompoundButton.OnCheckedChangeListener() {
                    @Override
                    public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
                        if (isChecked) {
                            //é™éŸ³
                            setVideoLiveWallpaperSilence(true);
                        } else {
                            setVideoLiveWallpaperSilence(false);
                        }
                    }
                });
```

- è¿™é‡Œå…¶å®VideoEngineçš„onCreate()è¿˜è¦åšä¸ªæ¢å¤æ“ä½œï¼Œä¸ºæ¯›å‘¢ï¼Ÿå› ä¸ºå›½äº§ROMæ€è¿›ç¨‹éƒ½æ€å¾—ç²¾å…‰ï¼Œä¸€ä¸ªå†…å­˜æ¸…ç†å°±æŠŠæˆ‘ä»¬çš„è§†é¢‘å£çº¸ç»™æ€æ²¡äº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬çš„è§†é¢‘åŠ¨æ€å£çº¸éƒ½æ˜¯Service~è®°å¾—å—ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªServiceï¼Œæ‰€ä»¥æ¡Œé¢çš„æ’­æ”¾æ“ä½œéƒ½åœ¨Serviceï¼ŒServiceæ­»äº†ï¼Œé‚£æ¡Œé¢çš„SufaceViewä¹Ÿå°±è·Ÿæˆ‘ä»¬çš„MediaPlayerè§£ç»‘äº†ğŸ˜‚...ï¼ˆæ˜¯å¦é™éŸ³ä¹Ÿè®°å½•åˆ°SPï¼Œæ–¹ä¾¿æ¢å¤ä¸Šæ¬¡çš„è®¾ç½®...è¿™é‡Œå¯¹å›½äº§ROMæ€ç²¾å…‰çš„åšæ³•æ— æ³•åæ§½...ï¼‰

```
@Override
        public void onCreate(SurfaceHolder surfaceHolder) {
		 super.onCreate(surfaceHolder);
        boolean isVolume = PropertyHelper.getProperty(Const.Key.KEY_WALLPAPER_VOLUME_IS_SILENCE, true);
        VideoLiveWallpaper.setVolume(this.getApplicationContext(), isVolume);
    }
```

#### æ€»ç»“

- é€šè¿‡å®˜æ–¹Apiï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªåŠ¨æ€å£çº¸ï¼Œä½†æ˜¯å›½äº§ROMåšäº†é˜‰å‰²...åªèƒ½è®¾ç½®æ¡Œé¢ï¼Œé”å±åŸºæœ¬æ˜¯ä»–ä»¬çš„ä¸»é¢˜è®¾ç½®ï¼Œæ— å¥ˆ...
- æ„Ÿè§‰å®˜æ–¹Apiä¸€å¼€å§‹æ²¡è®¾ç½®å¥½ï¼Œè·³è½¬åˆ°è®¾ç½®é¡µé¢åï¼Œä¹Ÿæ²¡æœ‰å›è°ƒç»™æˆ‘ä»¬ï¼Œæ˜¯å¦ç”¨æˆ·è®¾ç½®äº†æˆ‘ä»¬çš„åŠ¨æ€å£çº¸ã€‚ã€‚å¼ºåˆ¶ä¿å­˜åœ°å€ï¼Œé€šè¿‡å¹¿æ’­åˆ·æ–°ï¼Œä¹Ÿæ˜¯ç¼ºç‚¹ï¼Œä¸‡ä¸€ç”¨æˆ·é€‰æ‹©å®Œè§†é¢‘åˆä¸è®¾ç½®å‘¢ğŸ˜‚
- å›½äº§ROMæ¸…ç†å†…å­˜ï¼ŒServiceå°±è¢«æ€äº†...åŠ¨æ€å£çº¸å°±æ²¡äº†ï¼Œåªèƒ½å¼•å¯¼ç”¨æˆ·å»ç»™æˆ‘ä»¬çš„Appè®¾ç½®ç™½åå•ï¼Œæ¸…ç†æ—¶å¿½ç•¥æˆ‘ä»¬çš„Appäº†ã€‚
- æœ€åæˆ‘çš„è§†é¢‘åŠ¨æ€å£çº¸åšå¥½äº†~å¯ä»¥æ»¡å¿ƒæ¬¢å–œç»™å¥³æœ‹å‹ç‚«è€€äº†~
- æœ€åå‘ç°...æŸéŸ³å³ä¸Šè§’å…¶å®å¯ä»¥è®¾ç½®å½“å‰æ’­æ”¾çš„è§†é¢‘ä¸ºæ¡Œé¢åŠ¨æ€å£çº¸(ä»–ä»¬ä¹Ÿæ˜¯åªèƒ½è®¾ç½®æ¡Œé¢ï¼Œä¸èƒ½é”å±ä¹Ÿæœ‰)...ğŸ˜‚æˆ‘ã€‚ã€‚ã€‚